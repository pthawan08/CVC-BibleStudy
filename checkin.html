<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full border-t-4 border-[#C5A66B]">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üìù</h1>

        <form id="checkinForm" class="space-y-4">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">1. ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                <select id="studentName" required onchange="updateSubjectList()" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-[#C5A66B]">
                    <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">2. ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</label>
                <select id="subjectSelect" required class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-[#C5A66B] bg-gray-50">
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</label>
                <select id="weekNumber" required class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-[#C5A66B]">
                    <option value="1">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1</option>
                    <option value="2">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2</option>
                    <option value="3">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3</option>
                    <option value="4">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 4</option>
                    <option value="5">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5</option>
                    <option value="6">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 6</option>
                    <option value="7">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7</option>
                    <option value="8">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 8</option>
                    <option value="9">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 9</option>
                    <option value="10">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 10</option>
                </select>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-[#C5A66B] hover:bg-[#A68A55] text-white font-bold py-3 rounded-lg shadow mt-2">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </button>

            <a href="index.html" class="block text-center text-sm text-gray-400 mt-4 hover:text-gray-600">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£</a>
        </form>
    </div>

    <script>
        // ********************************************
        // üî¥ ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üî¥
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwyWkLuZJFukEylu3GVa6PB_yYlllyEdpuJjGRNqIuD_9M0lBYX19RmOxI0trzdUVYN/exec"; 
        // ********************************************

        let studentDataMap = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ä‡∏∑‡πà‡∏≠ -> ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        fetch(WEB_APP_URL)
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('studentName');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì --</option>';
            
            // data ‡∏Ñ‡∏∑‡∏≠ array ‡∏Ç‡∏≠‡∏á [‡∏ä‡∏∑‡πà‡∏≠, ‡∏ß‡∏¥‡∏ä‡∏≤1,‡∏ß‡∏¥‡∏ä‡∏≤2...]
            data.forEach(row => {
                const name = row[0];
                const subjects = row[1]; // String ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ comma
                studentDataMap[name] = subjects;

                const option = document.createElement('option');
                option.value = name;
                option.text = name;
                select.appendChild(option);
            });
        })
        .catch(err => console.error(err));

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠
        function updateSubjectList() {
            const name = document.getElementById('studentName').value;
            const subjectSelect = document.getElementById('subjectSelect');
            subjectSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>';

            if (name && studentDataMap[name]) {
                const subjects = studentDataMap[name].split(', ');
                subjects.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.text = sub;
                    subjectSelect.appendChild(option);
                });
            }
        }

        // ‡∏Å‡∏î‡∏™‡πà‡∏á
        document.getElementById('checkinForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const name = document.getElementById('studentName').value;
            const subject = document.getElementById('subjectSelect').value;
            const week = document.getElementById('weekNumber').value;

            btn.disabled = true;
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: "check", name, subject, week, check: true })
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1500, showConfirmButton: false });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            });
        });
    </script>
</body>
</html>
